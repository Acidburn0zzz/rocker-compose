namespace: patterns
containers:
  main:
    image: dockerhub.grammarly.io/patterns:{{ .version.patterns | default "latest" }}
    net: host
    pid: host
    state: running
    dns:
      - 8.8.8.8
    add_host:
      - capi.grammarly.com:127.0.0.1
    restart: always
    memory: 300M
    memory_swap: 1G
    cpu_shares: 512
    cpu_period: 0
    cpuset_cpus: 0-2
    # oom_kill_disable: true  # not supported by go-dockerclient
    ulimits:
      - name: nofile
        soft: 1024
        hard: 2048
    privileged: true
    cmd: ["param1", "param2"]
    entrypoint: ["/bin/patterns"]
    expose:
      - 23456/tcp
    publish_all_ports: true
    labels:
      service: pattern
      num: "1"
    env:
      AWS_KEY: asdqwe
    ports: # format: ip:hostPort:containerPort | ip::containerPort | hostPort:containerPort | containerPort
      - "8080:23456"
      - "0.0.0.0:5005:5005/tcp"
      - "5006:5006/tcp"
    volumes_from:
      - config
      - extdata
      - monitoring.sensu # may refer to containers that are not created by compose
    volumes:
      - /tmp/patterns/tmpfs:/tmp/tmpfs
      - /tmp/patterns/log:/opt/gr-pat/log:ro
      - /var/log
    links:
      - monitoring.sensu
    kill_timeout: 120
    hostname: pattern1
    domainname: grammarly.com
    user: root
    workdir: /app
    network_disabled: true

  main2:
    extends: main
    add_host:
      - capi.grammarly.com:127.0.0.2
    labels:
      type: replica
      num: "2"
    kill_timeout: 200

  config:
    image: dockerhub.grammarly.io/patterns-config:{{ .version.config | default "latest" }}
    state: created
    volumes:
      - ~/.ssh/id_rsa:/root/.ssh/id_rsa
      - ./log:/var/log:ro

  extdata:
    image: dockerhub.grammarly.io/patterns-extdata:{{ .version.extdata | default "latest" }}
    keep_volumes: true

  test:
    image: dockerhub.grammarly.io/patterns:{{ .version.patterns | default "latest" }}
    cmd: []

